<!DOCTYPE html>
<html>
<head>
    <title>Network Configuration</title>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="referrer no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <style type="text/css">
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            max-width: 500px;
            margin: 0 auto;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        input[type="submit"] {
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 3px;
            padding: 10px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        input[type="submit"]:hover {
            background-color: #0056b3;
        }
        input[type="submit"]:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #ap_list {
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }
        #ap_list .scanning {
            font-style: italic;
            color: #666;
        }
        #ap_list a {
            display: block;
            margin-top: 5px;
            padding: 5px;
            color: #007bff;
            text-decoration: none;
            border-radius: 3px;
        }
        #ap_list a:hover {
            text-decoration: underline;
            background-color: #e9ecef;
        }

        .language-switch {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .language-switch select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        /* Loading spinner styles */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .loading-overlay.show {
            display: flex;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .loading-text {
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Styles from done.html */
        #done-container {
            display: none; /* Initially hidden */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            max-height: 100vh;
            box-sizing: border-box;
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
        }

        .checkmark {
            width: 150px;
            height: 150px;
            margin-bottom: 30px;
        }

        .message {
            text-align: center;
            font-size: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="main-container">
        <div class="language-switch">
            <select id="language" onchange="changeLanguage()">
                <option value="de-DE">deutsch</option>
                <option value="en-US">English</option>
                <option value="zh-CN">简体中文</option>
                <option value="zh-TW">繁體中文</option>
                <option value="ja-JP">日本語</option>
            </select>
        </div>
        
        <div class="container">
            <div id="saved_list_container" style="display: none;">
                <h3 data-lang="saved_wifi">Saved Wi-Fi</h3>
                <ul id="saved_list"></ul>
            </div>
            <div>
                <h3 data-lang="new_wifi">New Wi-Fi</h3>
                <p class="error" style="color: red; text-align: center;" id="error"></p>
                <form action="/submit" method="post" onsubmit="submitForm(event)">
                    <p>
                        <label for="ssid">SSID:</label>
                        <input type="text" id="ssid" name="ssid" required readonly>
                    </p>
                    <p>
                        <label for="password" data-lang="password">Password:</label>
                        <input type="password" id="password" name="password">
                    </p>
                    <p style="text-align: center;">
                        <input type="submit" value="Connect" id="button" data-lang-value="connect">
                    </p>
                </form>
                <div id="ap_list"></div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" data-lang="connecting">Connecting...</div>
        </div>
    </div>

    <!-- Content from done.html -->
    <div id="done-container">
        <svg class="checkmark" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" stroke="#4CAF50" stroke-width="2"/>
            <path class="checkmark__check" fill="none" stroke="#4CAF50" stroke-width="2" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
        <div class="message">
            <p>设备将在 <span id="countdown">3</span> 秒后重启</p>
            <p>Device will restart in <span id="countdown-en">3</span> seconds</p>
        </div>
    </div>

    <script type="text/javascript">
        const button = document.getElementById('button');
        const error = document.getElementById('error');
        const ssid = document.getElementById('ssid');
        let support5G = false;

        const translations = {
            'zh-CN': {
                title: '网络配置',
                saved_wifi: '已保存的 Wi-Fi',
                new_wifi: '新的 Wi-Fi',
                password: '密码:',
                connect: '连接',
                connecting: '正在连接...',
                select_wifi: '从下面列表选择 2.4G Wi-Fi:',
                select_wifi_5g: '从下面列表选择 Wi-Fi:',
                scanning: '扫描中...'
            },
            'zh-TW': {
                title: '網路設定',
                saved_wifi: '已儲存的 Wi-Fi',
                new_wifi: '新的 Wi-Fi',
                password: '密碼:',
                connect: '連接',
                connecting: '正在連接...',
                select_wifi: '從下方列表選擇 2.4G Wi-Fi:',
                select_wifi_5g: '從下方列表選擇 Wi-Fi:',
                scanning: '掃描中...'
            },
            'de-DE': {
                title: 'Netzwerk-Konfiguration',
                saved_wifi: 'Gesicherte Wi-Fi-Verbindungen',
                new_wifi: 'Neue Wi-Fi-Verbindung',
                password: 'Passwort:',
                connect: 'verbinden',
                connecting: 'Verbindung wird hergestellt...',
                select_wifi: 'Wähle ein 2.4G Wi-Fi aus der Liste:',
                select_wifi_5g: 'Wähle ein Wi-Fi aus der Liste:',
                scanning: 'Scanne...'
            },
            'en-US': {
                title: 'Network Configuration',
                saved_wifi: 'Saved Wi-Fi',
                new_wifi: 'New Wi-Fi',
                password: 'Password:',
                connect: 'Connect',
                connecting: 'Connecting...',
                select_wifi: 'Select an 2.4G Wi-Fi from the list below:',
                select_wifi_5g: 'Select a Wi-Fi from the list below:',
                scanning: 'Scanning...'
            },
            'ja-JP': {
                title: 'ネットワーク設定',
                saved_wifi: '保存済みのWi-Fi',
                new_wifi: '新しいWi-Fi',
                password: 'パスワード:',
                connect: '接続',
                connecting: '接続中...',
                select_wifi: '以下のリストから2.4G Wi-Fiを選択してください:',
                select_wifi_5g: '以下のリストからWi-Fiを選択してください:',
                scanning: 'スキャン中...'
            }
        };

        function changeLanguage() {
            const lang = document.getElementById('language').value;
            if (!translations[lang]) {
                document.getElementById('language').value = 'en-US';
                return changeLanguage();
            }
            document.title = translations[lang].title;
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.querySelectorAll('[data-lang-value]').forEach(el => {
                const key = el.getAttribute('data-lang-value');
                if (translations[lang][key]) el.value = translations[lang][key];
            });
            const apList = document.getElementById('ap_list');
            if (apList.firstChild && apList.firstChild.tagName === 'P') {
                const selectText = support5G ? translations[lang].select_wifi_5g : translations[lang].select_wifi;
                apList.firstChild.textContent = selectText;
            }
            localStorage.setItem('preferred_language', lang);
        }

        function renderSavedList(data) {
            const container = document.getElementById('saved_list_container');
            const list = document.getElementById('saved_list');
            list.innerHTML = '';
            if (data.length === 0) {
                container.style.display = 'none';
                return;
            }
            data.forEach((ssid, index) => {
                const li = document.createElement('li');
                let html = `<span>${ssid}</span> <span>`;
                if (index > 0) {
                    html += `<button type="button" onclick="setDefaultItem(this, ${index})">⬆️</button> `;
                }
                html += `<button type="button" onclick="deleteItem(this, ${index})">❌</button></span>`;
                li.innerHTML = html;
                list.appendChild(li);
            });
            container.style.display = 'block';
        }

        function deleteItem(item, index) {
            item.disabled = true;
            fetch('/saved/delete?index=' + index).then(() => loadSavedList());
        }

        function setDefaultItem(item, index) {
            item.disabled = true;
            fetch('/saved/set_default?index=' + index).then(() => loadSavedList());
        }

        function loadSavedList() {
            fetch('/saved/list').then(response => response.json()).then(renderSavedList);
        }

        function loadAPList() {
            if (button.disabled) return;
            const lang = document.getElementById('language').value;
            const apList = document.getElementById('ap_list');
            if (!apList.querySelector('a')) {
                apList.innerHTML = `<p class="scanning">${translations[lang].scanning}</p>`;
            }
            fetch('/scan').then(response => response.json()).then(data => {
                support5G = data.support_5g;
                const selectText = support5G ? translations[lang].select_wifi_5g : translations[lang].select_wifi;
                apList.innerHTML = `<p>${selectText}</p>`;
                data.aps.forEach(ap => {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = `${ap.ssid} (${ap.rssi} dBm) ${ap.authmode === 0 ? '🌐' : '🔒'}`;
                    link.onclick = () => { ssid.value = ap.ssid; };
                    apList.appendChild(link);
                });
                setTimeout(loadAPList, 5000);
            }).catch(error => {
                console.error('Error:', error);
                setTimeout(loadAPList, 5000);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            const browserLang = navigator.language || navigator.userLanguage;
            const languageMap = {'zh': 'zh-CN','zh-CN': 'zh-CN','zh-TW': 'zh-TW','zh-HK': 'zh-TW','ja': 'ja-JP','ja-JP': 'ja-JP','en': 'en-US','en-US': 'en-US','en-GB': 'en-US'};
            const getSupportedLanguage = (lang) => {
                return languageMap[lang] || languageMap[lang.split('-')[0]] || 'en-US';
            };
            const savedLang = langParam || localStorage.getItem('preferred_language') || getSupportedLanguage(browserLang);
            document.getElementById('language').value = savedLang;
            changeLanguage();
            loadSavedList();
            loadAPList();
        });

        window.addEventListener('pageshow', (event) => {
            if (event.persisted) loadSavedList();
        });

        async function submitForm(event) {
            event.preventDefault();
            button.disabled = true;
            error.textContent = '';
            document.getElementById('loadingOverlay').classList.add('show');
            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ssid: ssid.value, password: document.getElementById('password').value })
                });
                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'Connection failed');
                document.getElementById('main-container').style.display = 'none';
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('done-container').style.display = 'flex';
                startCountdownAndReboot();
            } catch (err) {
                document.getElementById('loadingOverlay').classList.remove('show');
                error.textContent = err.message;
                button.disabled = false;
            }
        }

        function startCountdownAndReboot() {
            let count = 3;
            const countdownEl = document.getElementById('countdown');
            const countdownEnEl = document.getElementById('countdown-en');
            const timer = setInterval(() => {
                count--;
                countdownEl.textContent = count;
                countdownEnEl.textContent = count;
                if (count <= 0) {
                    clearInterval(timer);
                    fetch('/reboot', { method: 'POST' })
                        .then(response => { if (response.ok) window.close(); })
                        .catch(error => console.error('Error:', error));
                }
            }, 1000);
        }

        ssid.addEventListener('touchstart', () => {
            ssid.removeAttribute('readonly');
            ssid.focus();
        }, {once: true});
    </script>
</body>
</html>